<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ì¶”ì²œì˜ìƒ ë“±ë¡ - CopyTube</title>

  <!-- CSP (ë³´ì•ˆ ê°•í™”) -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    connect-src 'self' https://www.googleapis.com https://firestore.googleapis.com https://securetoken.googleapis.com https://identitytoolkit.googleapis.com https://www.gstatic.com https://www.youtube.com;
    img-src 'self' data: https://i.ytimg.com;
    frame-src https://www.youtube.com;
    script-src 'self' https://www.gstatic.com 'unsafe-inline';
    style-src 'self' 'unsafe-inline';
    object-src 'none';
    base-uri 'self';
  ">

  <link rel="stylesheet" href="css/style.css"/>

  <style>
    /* ===== ìƒë‹¨ ì»¨íŠ¸ë¡¤ ì˜ì—­ (ë¼ë””ì˜¤ 2ì¤„ + ë¶™ì—¬ë„£ê¸° + ë“±ë¡) ===== */
    .controls-grid{
      display:grid;
      grid-template-columns: minmax(160px, 40%) 1fr 1fr; /* ì¢Œ: ë¼ë””ì˜¤, ìš°: ë²„íŠ¼ ë‘ ì¹¸ */
      grid-template-rows: auto auto; /* ë¼ë””ì˜¤ 2ì¤„ */
      gap:10px;
      align-items:stretch;
      margin:10px 0 8px;
    }
    .order-col{
      display:grid;
      grid-template-rows: 1fr 1fr;
      gap:10px;
    }
    .pill-radio{
      display:flex; align-items:center; gap:10px;
      padding:12px 14px; border-radius:10px;
      background:#121212; border:1px solid #2a2a2a; color:#e5e7eb;
      font-weight:700;
    }
    .pill-radio input{ accent-color:#4ea1ff; transform:scale(1.1); }

    .btn-clip, .btn-submit{
      grid-row: span 2;
      display:flex; align-items:center; justify-content:center; text-align:center;
      border:0; border-radius:12px; cursor:pointer;
      font-weight:800; line-height:1.2;
      padding:0 12px;
      min-height:96px;
    }
    @media (min-width: 900px){
      .btn-clip, .btn-submit{ min-height:110px; }
    }
    .btn-clip{
      background:#22c55e; color:#fff;
      font-size:16px;
      white-space:normal;
      word-break:keep-all;
    }
    .btn-submit{
      background:#4ea1ff; color:#fff;
      font-size:16px;
    }

    /* ë“±ë¡ ê²°ê³¼/ì—ëŸ¬ ë©”ì‹œì§€ */
    .msg{ margin-top:10px; font-size:13px; color:#ccc; white-space:pre-line; min-height:1.2em; }

    /* ë„ì›€ë§ */
    details.help{ margin:10px 0 8px; }
    details.help summary{
      cursor:pointer; user-select:none; font-weight:800; color:#e5e7eb;
      list-style: disclosure-closed;
    }
    details.help[open] summary{ list-style: disclosure-open; }
    .help-body{ margin-top:8px; color:#bfc6ce; font-size:14px; line-height:1.6; }

    /* ê°œì¸ìë£Œ ìœ„ì¹˜ ìŠ¤ìœ„ì¹˜ */
    .personal-pos{
      display:flex; gap:12px; align-items:center; margin:6px 0 10px;
      color:#bfc6ce; font-size:14px;
    }
    .personal-pos label{
      display:inline-flex; align-items:center; gap:6px;
      background:#121212; border:1px solid #2a2a2a; border-radius:10px;
      padding:6px 10px; cursor:pointer;
    }
    .personal-pos input{ accent-color:#4ea1ff; transform:scale(1.05); }

    /* ì¹´í…Œê³ ë¦¬ ë°•ìŠ¤ëŠ” ì¸ë±ìŠ¤ì™€ ë™ì¼ ë°€ë„ */
    .group{
      border:1px solid var(--border); border-radius:12px; background:var(--bg-3);
      padding:8px; margin:8px 0;
      text-align:left; max-width:900px; margin-left:auto; margin-right:auto;
    }
    .group legend{
      padding:0 4px; font-weight:800; font-size:15px; color:#eee;
      margin-bottom:2px; line-height:1.05; display:inline-flex; gap:6px; align-items:center;
    }
    .group .subnote{ font-size:12px; color:#9aa0a6; margin-left:6px; }
    .child-grid{
      margin-top:2px; display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:4px;
    }
    @media (min-width:900px){ .child-grid{ grid-template-columns:repeat(4, minmax(0,1fr)); } }
    .child-grid label{
      background:#0f0f0f; border:1px solid #2a2a2a; border-radius:8px;
      padding:6px 8px; font-size:14px; line-height:1.2;
      display:flex; gap:6px; align-items:center; justify-content:flex-start;
    }
    .rename-btn{
      margin-left:auto; font-size:12px; padding:4px 6px; border-radius:6px;
      border:1px solid #2a2a2a; background:#151515; color:#bfc6ce; cursor:pointer;
    }
  </style>
</head>
<body>
  <!-- ìƒë‹¨ë°” -->
  <header id="topbar">
    <div class="brand">
      <a id="brandHome" href="./" aria-label="CopyTube í™ˆìœ¼ë¡œ">
        <img class="brand-logo" src="image/copytube_logo_side.png" alt="CopyTube"/>
      </a>
    </div>
    <div class="right" style="position:relative;">
      <a id="signupLink" class="link" href="signup.html">Sign up</a>
      <a id="signinLink" class="link" href="signin.html">Sign in</a>
      <span id="welcome" class="welcome"></span>
      <button id="menuBtn" class="icon hidden" aria-label="menu">ä¸‰</button>

      <!-- ë“œë¡­ë‹¤ìš´ -->
      <div id="dropdownMenu" class="dropdown hidden" role="menu" aria-hidden="true">
        <button id="btnAbout" type="button">CopyTubeëŠ”â€¦</button>
        <button id="btnMyUploads" type="button">ë‚´ì˜ìƒê´€ë¦¬</button>
        <button id="btnSignOut" type="button">Sign out</button>
        <button id="btnGoUpload" class="menu-strong" type="button">ì¶”ì²œì˜ìƒë“±ë¡</button>
      </div>
    </div>
  </header>

  <main class="intro" style="align-items:flex-start; padding-top:96px;">
    <div style="max-width:900px; width:100%; text-align:left;">
      <h2>ì¶”ì²œì˜ìƒ ë“±ë¡</h2>

      <label style="display:block;margin-top:14px;">YouTube ê³µìœ  URLë“¤ (ì—¬ëŸ¬ ì¤„ ê°€ëŠ¥)
        <textarea id="urls" rows="3" placeholder="https://youtu.be/aaa...&#10;https://www.youtube.com/watch?v=bbb...&#10;..." style="width:100%;padding:12px;margin-top:6px;border-radius:8px;border:1px solid #333;background:#000;color:#fff;"></textarea>
      </label>

      <!-- ë¼ë””ì˜¤(2ì¤„) + ë¶™ì—¬ë„£ê¸° + ë“±ë¡ -->
      <div class="controls-grid" id="controlsGrid">
        <div class="order-col">
          <label class="pill-radio"><input type="radio" name="order" value="bottom" checked> ì•„ë˜ë¶€í„° ë“±ë¡</label>
          <label class="pill-radio"><input type="radio" name="order" value="top"> ìœ„ë¶€í„° ë“±ë¡</label>
        </div>

        <button id="btnPaste" class="btn-clip" type="button" title="í´ë¦½ë³´ë“œì—ì„œ ë¶™ì—¬ë„£ê¸°">
          í´ë¦½ë³´ë“œ<br/>ë¶™ì—¬ë„£ê¸°
        </button>

        <button id="btnSubmitTop" class="btn-submit" type="button">ë“±ë¡</button>
      </div>

      <!-- ğŸ”¼ ì¶”ê°€: ìƒë‹¨ ë©”ì‹œì§€ -->
      <div id="msgTop" class="msg"></div>

      <!-- ë¶™ì—¬ë„£ê¸° ë„ì›€ë§ -->
      <details class="help" id="pasteHelp">
        <summary>ë¶™ì—¬ë„£ê¸° ë„ì›€ë§</summary>
        <div class="help-body">
          â€¢ <b>URL ì…ë ¥ì¹¸</b>ì— ì§ì ‘ ë¶™ì—¬ë„£ê±°ë‚˜, <b>ì˜¤ë¥¸ìª½ â€œí´ë¦½ë³´ë“œ ë¶™ì—¬ë„£ê¸°â€</b> ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì„¸ìš”. (ë¸Œë¼ìš°ì €/OS í—ˆìš© í•„ìš”)<br/>
          â€¢ <b>URL ë‹¤ì¤‘ë“±ë¡:</b> ì…ë ¥ì¹¸ì— <b>í•œ ì¤„ì— 1ê°œì˜ URL</b>ì„ ë„£ê³ , <b>ì¹´í…Œê³ ë¦¬ ì„ íƒ í›„ â€œë“±ë¡â€</b>ì„ ëˆ„ë¥´ë©´ ëª¨ë‘ ë“±ë¡ë©ë‹ˆë‹¤.<br/>
          â€¢ ìœ„ì˜ <b>â€œì•„ë˜ë¶€í„°/ìœ„ë¶€í„° ë“±ë¡â€</b> ì˜µì…˜ìœ¼ë¡œ ë“±ë¡ ìˆœì„œë¥¼ ì •í•©ë‹ˆë‹¤. (í”¼ë“œëŠ” ìµœì‹ ìˆœì´ë¼ ì‹œë¦¬ì¦ˆëŠ” ë³´í†µ <b>ì•„ë˜ë¶€í„°</b>ê°€ ì í•©í•©ë‹ˆë‹¤.)<br/><br/>
          â€¢ <b>HTTPS</b> í™˜ê²½ì—ì„œë§Œ ì‘ë™í•©ë‹ˆë‹¤. (GitHub Pages OK)<br/>
          â€¢ <b>iPhone/iPad</b>: ì²˜ìŒ ë¶™ì—¬ë„£ê¸° ì‹œ <i>â€œì´ ì•±ì—ì„œ ë¶™ì—¬ë„£ê¸° í—ˆìš©â€</i> íŒì—…ì—ì„œ <b>í—ˆìš©</b> ì„ íƒ<br/>
          â€¢ <b>ì•ˆë“œë¡œì´ë“œ/ë°ìŠ¤í¬íƒ‘ Chrome</b>: <b>ì„¤ì • â†’ ì‚¬ì´íŠ¸ ì„¤ì • â†’ í´ë¦½ë³´ë“œ</b>ì—ì„œ <code>https://copytube.github.io</code> <b>í—ˆìš©</b><br/>
          â€¢ ë˜ëŠ” <b>ê¸¸ê²Œ ëˆ„ë¥´ê¸° â†’ ë¶™ì—¬ë„£ê¸°</b> í˜¹ì€ <code>Ctrl/âŒ˜+V</code>ë¥¼ ì‚¬ìš©í•˜ì…”ë„ ë©ë‹ˆë‹¤.<br/><br/>
          â€¢ <b>ê°œì¸ìë£Œ</b>ëŠ” ë¡œì»¬ì €ì¥ì†Œì— ì €ì¥ë˜ë©° ê³µìœ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ë¦„ ë³€ê²½ ê°€ëŠ¥í•˜ê³ , ìœ„ì¹˜ë¥¼ ìƒë‹¨ìœ¼ë¡œ ì˜¬ë¦´ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤(ì•„ë˜ ìŠ¤ìœ„ì¹˜).
        </div>
      </details>

      <!-- ê°œì¸ìë£Œ ìœ„ì¹˜ ìŠ¤ìœ„ì¹˜ -->
      <div id="personalPosRow" class="personal-pos">
        <span>ê°œì¸ìë£Œ ìœ„ì¹˜</span>
        <label><input type="radio" name="personalPos" value="bottom" checked> í•˜ë‹¨</label>
        <label><input type="radio" name="personalPos" value="top"> ìƒë‹¨</label>
      </div>

      <p style="margin:10px 0 6px;color:#bfc6ce;">ì¹´í…Œê³ ë¦¬ëŠ” <b>ìµœëŒ€ 3ê°œ</b>ê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
      <div id="cats"><!-- JSë¡œ ì¹´í…Œê³ ë¦¬ ë Œë”ë§ --></div>

      <!-- í•˜ë‹¨ ë“±ë¡ ë²„íŠ¼ (ë™ì¼ ê¸°ëŠ¥) -->
      <button id="btnSubmitBottom" class="btn-submit" type="button" style="width:100%;margin-top:10px;min-height:56px;">ë“±ë¡</button>

      <div id="msg" class="msg"></div>
    </div>
  </main>

  <!-- ëª¨ë“ˆ ìŠ¤í¬ë¦½íŠ¸ -->
  <script type="module">
    import { auth, db } from './js/firebase-init.js';
    import { onAuthStateChanged } from './js/auth.js';
    import { addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { CATEGORY_GROUPS } from './js/categories.js';

    /* ---------- ìƒë‹¨ë°”/ë“œë¡­ë‹¤ìš´ ---------- */
    const signupLink   = document.getElementById("signupLink");
    const signinLink   = document.getElementById("signinLink");
    const welcome      = document.getElementById("welcome");
    const menuBtn      = document.getElementById("menuBtn");
    const dropdown     = document.getElementById("dropdownMenu");
    const btnSignOut   = document.getElementById("btnSignOut");
    const btnGoUpload  = document.getElementById("btnGoUpload");
    const btnMyUploads = document.getElementById("btnMyUploads");
    const btnAbout     = document.getElementById("btnAbout");

    let isMenuOpen = false;
    function openDropdown(){ isMenuOpen = true; dropdown.classList.remove("hidden"); requestAnimationFrame(()=> dropdown.classList.add("show")); }
    function closeDropdown(){ isMenuOpen = false; dropdown.classList.remove("show"); setTimeout(()=> dropdown.classList.add("hidden"), 180); }

    onAuthStateChanged(auth, (user)=>{
      const loggedIn = !!user;
      signupLink.classList.toggle("hidden", loggedIn);
      signinLink.classList.toggle("hidden", loggedIn);
      menuBtn.classList.toggle("hidden", !loggedIn);
      welcome.textContent = loggedIn ? `ì•ˆë…•í•˜ì„¸ìš”, ${user.displayName || 'íšŒì›'}ë‹˜` : "";
      closeDropdown();
    });

    menuBtn.addEventListener("click",(e)=>{ e.stopPropagation(); dropdown.classList.contains("hidden") ? openDropdown() : closeDropdown(); });
    document.addEventListener('pointerdown',(e)=>{ if(dropdown.classList.contains('hidden')) return; if(!e.target.closest('#dropdownMenu, #menuBtn')) closeDropdown(); }, true);
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeDropdown(); });
    dropdown.addEventListener("click",(e)=> e.stopPropagation());
    btnGoUpload?.addEventListener("click", ()=>{ location.href = "upload.html"; closeDropdown(); });
    btnMyUploads?.addEventListener("click", ()=>{ location.href = "manage-uploads.html"; closeDropdown(); });
    btnAbout?.addEventListener("click", ()=>{ location.href = "about.html"; closeDropdown(); });

    /* ---------- ê°œì¸ìë£Œ ë¼ë²¨/ìœ„ì¹˜ ---------- */
    const $ = sel => document.querySelector(sel);
    const catsBox = $('#cats');
    const msg = $('#msg');
    const msgTop = $('#msgTop'); // ğŸ”¼ ì¶”ê°€
    const urlsBox = $('#urls');

    // ê³µí†µ ë©”ì‹œì§€ í—¬í¼ ğŸ”¼ ì¶”ê°€
    function setMsg(text){
      if (msgTop) msgTop.textContent = text || '';
      if (msg)    msg.textContent    = text || '';
    }

    function getPersonalLabels(){
      try{ return JSON.parse(localStorage.getItem('personalLabels')||'{}'); }catch{ return {}; }
    }
    function setPersonalLabel(key, label){
      const labels = getPersonalLabels();
      labels[key] = label;
      localStorage.setItem('personalLabels', JSON.stringify(labels));
    }
    function getPersonalPosition(){
      const v = localStorage.getItem('personalPosition');
      return v === 'top' ? 'top' : 'bottom';
    }
    function setPersonalPosition(pos){
      localStorage.setItem('personalPosition', pos === 'top' ? 'top' : 'bottom');
    }

    /* ---------- ì¹´í…Œê³ ë¦¬ ë Œë” ---------- */
    function renderCats(){
      const personalLabels = getPersonalLabels();
      const pos = getPersonalPosition();

      const groups = CATEGORY_GROUPS.slice();
      if (pos === 'top'){
        const i = groups.findIndex(g=>g.key==='personal');
        if(i>-1){ const [pg] = groups.splice(i,1); groups.unshift(pg); }
      }

      const html = groups.map(g=>{
        const kids = g.children.map(c=>{
          const isPersonal = (g.key==='personal');
          const defaultLabel = (c.value==='personal1') ? 'ìë£Œ1' : (c.value==='personal2' ? 'ìë£Œ2' : c.label);
          const labelText = isPersonal && personalLabels[c.value] ? personalLabels[c.value] : defaultLabel;
          const rename = isPersonal
            ? `<button class="rename-btn" data-key="${c.value}" type="button">ì´ë¦„ë³€ê²½</button>`
            : '';
          return `<label><input type="checkbox" class="cat" value="${c.value}"> ${labelText}${rename}</label>`;
        }).join('');

        const legend = (g.key==='personal')
          ? `${g.label} <span class="subnote">(ë¡œì»¬ì €ì¥ì†Œ)</span>`
          : g.label;

        return `
          <fieldset class="group" data-key="${g.key}">
            <legend>${legend}</legend>
            <div class="child-grid">${kids}</div>
          </fieldset>
        `;
      }).join('');

      catsBox.innerHTML = html;

      catsBox.querySelectorAll('.rename-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const key = btn.getAttribute('data-key');
          const cur = getPersonalLabels()[key] || (key==='personal1'?'ìë£Œ1':'ìë£Œ2');
          const name = prompt('ê°œì¸ìë£Œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 12ì):', cur);
          const clean = (name||'').trim().slice(0,12).replace(/[<>"]/g,'');
          if(!clean) return;
          setPersonalLabel(key, clean);
          renderCats();
        });
      });

      const limit = 3;
      catsBox.querySelectorAll('input.cat').forEach(chk=>{
        chk.addEventListener('change', ()=>{
          const checked = Array.from(catsBox.querySelectorAll('input.cat:checked'))
            .filter(x=> x.value!=='personal1' && x.value!=='personal2');
          if (checked.length > limit){
            chk.checked = false;
            alert(`ì¹´í…Œê³ ë¦¬ëŠ” ìµœëŒ€ ${limit}ê°œê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
          }
        });
      });
    }
    renderCats();

    (function initPersonalPosUI(){
      const box = $('#personalPosRow');
      if(!box) return;
      const cur = getPersonalPosition();
      const curEl = box.querySelector(`input[name="personalPos"][value="${cur}"]`);
      if(curEl) curEl.checked = true;
      box.querySelectorAll('input[name="personalPos"]').forEach(r=>{
        r.addEventListener('change', (e)=>{
          setPersonalPosition(e.target.value);
          renderCats();
        });
      });
    })();

    /* ---------- ìœ í‹¸ ---------- */
    function extractId(url){
      const m = String(url).match(/(?:youtu\.be\/|v=|shorts\/)([^?&/]+)/);
      return m ? m[1] : '';
    }
    function parseInputUrls(){
      const lines = urlsBox.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      return lines;
    }
    async function pasteFromClipboard(){
      try{
        const txt = await navigator.clipboard.readText();
        if(!txt) { setMsg('í´ë¦½ë³´ë“œì— í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
        if (urlsBox.value.trim()){
          urlsBox.value = urlsBox.value.replace(/\s*$/,'') + '\n' + txt.trim();
        }else{
          urlsBox.value = txt.trim();
        }
        setMsg('ë¶™ì—¬ë„£ê¸° ì™„ë£Œ.');
      }catch(e){
        setMsg('í´ë¦½ë³´ë“œ ì ‘ê·¼ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í—ˆìš©í•´ ì£¼ì„¸ìš”.');
      }
    }

    /* ---------- ì—…ë¡œë“œ ---------- */
    async function submitAll(){
      setMsg('ë“±ë¡ ì¤‘...');

      const user = auth.currentUser;
      if(!user){ setMsg('ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.'); return; }

      const urls = parseInputUrls();
      if(!urls.length){ setMsg('URLì„ í•œ ì¤„ì— í•˜ë‚˜ì”© ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }

      const categories = Array.from(document.querySelectorAll('.cat:checked')).map(c=>c.value)
        .filter(v => v!=='personal1' && v!=='personal2');
      if(!categories.length){ setMsg('ì¹´í…Œê³ ë¦¬ë¥¼ ìµœì†Œ 1ê°œ ì„ íƒí•´ ì£¼ì„¸ìš”.'); return; }
      if(categories.length > 3){ setMsg('ì¹´í…Œê³ ë¦¬ëŠ” ìµœëŒ€ 3ê°œê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.'); return; }

      const order = (document.querySelector('input[name="order"]:checked')?.value || 'bottom');
      const list = (order === 'bottom') ? urls.slice().reverse() : urls.slice();

      let ok = 0, fail = 0;
      for(const url of list){
        const id = extractId(url);
        if(!id){ fail++; continue; }
        try{
          await addDoc(collection(db,'videos'), {
            url: url, categories, uid: user.uid, createdAt: serverTimestamp()
          });
          ok++;
        }catch(e){ fail++; }
      }

      // ê²°ê³¼ ë©”ì‹œì§€: ìœ„/ì•„ë˜ ë™ì‹œ í‘œì‹œ
      setMsg(`ë“±ë¡ ì™„ë£Œ: ${ok}ê±´ ì„±ê³µ, ${fail}ê±´ ì‹¤íŒ¨`);

      // ğŸ”½ ë“±ë¡ í›„ ì´ˆê¸°í™”: ì¹´í…Œê³ ë¦¬ ì²´í¬ í•´ì œ & URL ì…ë ¥ì¹¸ ë¹„ìš°ê¸°
      document.querySelectorAll('.cat:checked').forEach(ch => ch.checked = false);
      urlsBox.value = '';
    }

    // ë²„íŠ¼ ë°”ì¸ë”©
    document.getElementById('btnPaste').addEventListener('click', pasteFromClipboard);
    document.getElementById('btnSubmitTop').addEventListener('click', submitAll);
    document.getElementById('btnSubmitBottom').addEventListener('click', submitAll);
  </script>
</body>
</html>
